<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="explore.css">
    <link rel="stylesheet" href="trade.css">
    <title>Trades - Nexus</title>
</head>
<body data-page="trade">

    <header class="top_bar">

        <a href="index.html" class="logo">
            <span class="nexus_logo">N</span>
            <span class="nexus">Nexus</span>
        </a>

        <div class="buttons_footer">
            <a href="index.html" class="home_button">Home</a>
            <a href="explore.html" class="explore_button">Explore</a>
            <a href="wishlist.html" class="wishlist_button">Wishlist</a>
            <a href="trade.html" class="trades_button">Trades</a>
            <a href="create.html" class="create_button">Mint</a>
            <a href="profile.html" class="profile_button">Profile</a>
            <a href="dashboard.html" id="ownerDashboardLink" class="profile_button" style="visibility:hidden">Dashboard</a>
        </div>

        <a href="login.html" class="connect_wallet">
            <span class="connect_wallet_text">Login</span>
        </a>

    </header>

    <div class="trade_page">
        <div class="trade_header">
            <h1 class="trade_title">Trades</h1>
            <span class="trade_subtitle">All NFTs currently listed for sale by their owners.</span>
        </div>

        <div id="createTradeSection"></div>

        <div class="trades_table_wrapper">
            <table class="trades_table">
                <thead>
                    <tr>
                        <th>Thumbnail</th>
                        <th>NFT</th>
                        <th>Creator</th>
                        <th>Selling Price</th>
                        <th>Value (USD)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tradesBody">
                    <tr>
                        <td colspan="6">Loading trades...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer class="footer">

        <div class="footer1">

            <div class = "footer11">
            <span class="nexus_logo">N</span>
            <span class="footer_text_big">Nexus</span>
            </div>

            <div class="footer12">
                <span class="footer_text">The future of digital art collecting. Discover, collect, and trade unique NFTs.</span>
            
            </div>

        </div>

        <div class="footer2">
        
            <span class="footer_text_big">Marketplace</span>
            <a href="explore.html" class="small_button_footer">Explore</a>
            <a href="create.html" class="small_button_footer">Mint</a>
            <a href="collections.html" class="small_button_footer">Collections</a>

        </div>

        <div class="footer3">

            <span class="footer_text_big">Resources</span>
            <a href="helpcenter.html" class="small_button_footer">Help Center</a>
            <a href="contact.html" class="small_button_footer">Contact</a>
            <a href="newsletter.html" class="small_button_footer">Newsletter</a>

        </div>

        <div class="footer4">
            <span class="footer_text_big">Community</span>
            <div class="footer41">
            <a href="https://www.twitter.com" class="twitter">
                <svg class="icon-twitter" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none">
                    <path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z">
                    </path>
                 </svg>  
            </a>

            <a href="https://www.twitter.com" class="message">
                <svg class="icon-message" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none">
                    <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z">
                    </path>
                 </svg>  
            </a>

            <a href="https://github.com/AKVlad04/SavuVladutGeorge" class="github">
                <svg class="icon-github" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none">
                    <path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path>
                    <path d="M9 18c-4.51 2-5-2-7-2"></path>
                </svg>  
            </a>
        </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script src="owner.js"></script>
    <script>
        let currentUserId = null;

        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        async function loadTrades() {
            const tbody = document.getElementById('tradesBody');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="6">Loading trades...</td></tr>';
            try {
                const resp = await fetch('get_trades.php');
                const data = await resp.json();
                if (!Array.isArray(data) || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No trades yet.</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                data.forEach(tr => {
                    const trEl = document.createElement('tr');
                    const priceEth = (tr.price || 0).toFixed(4);
                    const valueUsd = (tr.value_usd || 0).toFixed(2);
                    const isOwner = currentUserId && Number(currentUserId) === Number(tr.seller_id);
                    trEl.innerHTML = `
                        <td><img src="${tr.image_url}" alt="${tr.name}" class="trade_thumb"></td>
                        <td>${tr.name}</td>
                        <td>${tr.creator_name || ''}</td>
                        <td>${priceEth} ETH</td>
                        <td>$${valueUsd}</td>
                        <td>
                            ${isOwner
                                ? '<button class="trade_cancel_btn" type="button">Cancel</button>'
                                : '<button class="trade_accept_btn" type="button">Accept</button>'}
                        </td>
                    `;
                    const acceptBtn = trEl.querySelector('.trade_accept_btn');
                    const cancelBtn = trEl.querySelector('.trade_cancel_btn');

                    if (acceptBtn) {
                        acceptBtn.addEventListener('click', async () => {
                            try {
                                acceptBtn.disabled = true;
                                const resp = await fetch('trade_action.php', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ trade_id: tr.trade_id, action: 'accept' })
                                });
                                const dataResp = await resp.json();
                                if (resp.status === 401 || (dataResp && (dataResp.error === 'not_authenticated' || dataResp.error === 'not_logged_in'))) {
                                    window.location.href = 'login.html';
                                    return;
                                }
                                if (!resp.ok || !dataResp.ok) {
                                    const code = dataResp && dataResp.error ? dataResp.error : 'unknown_error';
                                    if (code === 'insufficient_funds') {
                                        alert('Insufficient balance to buy this NFT.');
                                    } else if (code === 'cannot_accept_own_trade') {
                                        alert('You cannot accept your own trade.');
                                    } else if (code === 'trade_not_open') {
                                        alert('This trade is no longer open.');
                                    } else {
                                        alert('Could not accept trade.');
                                    }
                                } else {
                                    alert('Trade accepted successfully.');
                                    loadTrades();
                                }
                            } catch (e) {
                                console.error('accept trade failed', e);
                                alert('Network error while accepting trade.');
                            } finally {
                                acceptBtn.disabled = false;
                            }
                        });
                    }

                    if (cancelBtn) {
                        cancelBtn.addEventListener('click', async () => {
                            if (!confirm('Cancel this trade?')) return;
                            try {
                                cancelBtn.disabled = true;
                                const resp = await fetch('trade_action.php', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ trade_id: tr.trade_id, action: 'cancel' })
                                });
                                const dataResp = await resp.json();
                                if (resp.status === 401 || (dataResp && (dataResp.error === 'not_authenticated' || dataResp.error === 'not_logged_in'))) {
                                    window.location.href = 'login.html';
                                    return;
                                }
                                if (!resp.ok || !dataResp.ok) {
                                    alert('Could not cancel trade.');
                                } else {
                                    loadTrades();
                                }
                            } catch (e) {
                                console.error('cancel trade failed', e);
                                alert('Network error while cancelling trade.');
                            } finally {
                                cancelBtn.disabled = false;
                            }
                        });
                    }
                    tbody.appendChild(trEl);
                });
            } catch (e) {
                console.error('Failed to load trades', e);
                tbody.innerHTML = '<tr><td colspan="6">Failed to load trades.</td></tr>';
            }
        }

        async function initCreateTradeSection() {
            const section = document.getElementById('createTradeSection');
            if (!section) return;
            const nftId = getQueryParam('nft_id');
            if (!nftId) {
                section.innerHTML = '';
                return;
            }
            try {
                const resp = await fetch('nfts.php');
                const nfts = await resp.json();
                if (!Array.isArray(nfts)) return;
                const nft = nfts.find(n => Number(n.id) === Number(nftId));
                if (!nft) {
                    section.innerHTML = '<p class="empty_msg">NFT not found or not visible.</p>';
                    return;
                }
                const card = document.createElement('div');
                card.className = 'create_trade_card';
                card.innerHTML = `
                    <div class="create_trade_thumbnail">
                        <img src="${nft.image_url || 'img/placeholder.jpg'}" alt="${nft.name}">
                    </div>
                    <div class="create_trade_info">
                        <div class="create_trade_name">${nft.name}</div>
                        <div class="create_trade_price_row">
                            <label for="tradePriceInput">Selling price (ETH)</label>
                            <input type="number" id="tradePriceInput" min="0" step="0.0001" placeholder="e.g. ${nft.price || 0}">
                            <button type="button" id="createTradeBtn">Create Trade</button>
                        </div>
                        <div class="create_trade_status" id="createTradeStatus"></div>
                    </div>
                `;
                section.innerHTML = '';
                section.appendChild(card);

                const priceInput = document.getElementById('tradePriceInput');
                const createBtn = document.getElementById('createTradeBtn');
                const statusEl = document.getElementById('createTradeStatus');

                createBtn.addEventListener('click', async () => {
                    const val = parseFloat(priceInput.value);
                    if (!val || val <= 0) {
                        statusEl.style.color = '#f97373';
                        statusEl.textContent = 'Please enter a valid price in ETH.';
                        return;
                    }
                    createBtn.disabled = true;
                    statusEl.style.color = '#9ca3af';
                    statusEl.textContent = 'Creating trade...';
                    try {
                        const resp = await fetch('create_trade.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ nft_id: Number(nftId), price: val })
                        });
                        const data = await resp.json();
                        if (data && data.error === 'not_logged_in') {
                            window.location.href = 'login.html';
                            return;
                        }
                        if (data && data.ok) {
                            statusEl.style.color = '#10b981';
                            statusEl.textContent = data.updated ? 'Trade updated.' : 'Trade created.';
                            loadTrades();
                        } else {
                            statusEl.style.color = '#f97373';
                            statusEl.textContent = data && data.error ? ('Error: ' + data.error) : 'Could not create trade.';
                        }
                    } catch (e) {
                        console.error('create_trade failed', e);
                        statusEl.style.color = '#f97373';
                        statusEl.textContent = 'Network error while creating trade.';
                    } finally {
                        createBtn.disabled = false;
                    }
                });
            } catch (e) {
                console.error('Failed to init create trade section', e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Get current user id if logged in
            fetch('get_profile.php')
                .then(r => r.ok ? r.json() : Promise.reject())
                .then(profile => {
                    if (profile && profile.logged_in) {
                        currentUserId = profile.id;
                    } else {
                        currentUserId = null;
                    }
                })
                .catch(() => {
                    currentUserId = null;
                })
                .finally(() => {
                    initCreateTradeSection();
                    loadTrades();
                });
        });
    </script>

</body>
</html>
