<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="profile.css">
    <title>Public Profile - Nexus</title>
</head>
<body>
    <header class="top_bar">

        <a href="index.html" class="logo">
            <span class="nexus_logo">N</span>
            <span class="nexus">Nexus</span>
        </a>

        <div class="buttons_footer">
            <a href="index.html" class="home_button">Home</a>
            <a href="explore.html" class="explore_button">Explore</a>
            <a href="wishlist.html" class="wishlist_button">Wishlist</a>
            <a href="create.html" class="create_button">Mint</a>
            <a href="profile.html" class="profile_button">Profile</a>
            <a href="dashboard.html" id="ownerDashboardLink" class="profile_button" style="visibility:hidden">Dashboard</a>
        </div>

        <a href="login.html" class="connect_wallet">
            <span class="connect_wallet_text">Login</span>
        </a>

    </header>
    <div class="profile_page">
        <div class="profile_card" id="profileCard" style="opacity: 0; transition: opacity 0.5s;">
            <div class="profile_avatar" id="userAvatar">?</div>
            <h1 class="profile_name" id="userName">Loading...</h1>
            <span class="profile_email" id="userEmail">...</span>
            <div class="profile_stats">
                <div class="stat_box">
                    <span class="stat_value" id="userRole">...</span>
                    <span class="stat_label">Role</span>
                </div>
                <div class="stat_box">
                    <span class="stat_value" id="userStatus" style="color: #10b981;">...</span>
                    <span class="stat_label">Status</span>
                </div>
                <div class="stat_box">
                    <span class="stat_value" id="userId">#0</span>
                    <span class="stat_label">ID</span>
                </div>
            </div>
            <div class="wallet_row">
                <label>Wallet address</label>
                <div class="wallet_controls">
                    <input type="text" id="walletInput" readonly />
                </div>
            </div>
        </div>
        <div class="owned_section" id="ownedSection" style="width:100%; max-width:1100px; margin-top:30px; display:none">
            <h2 style="color:#fff; margin-bottom:12px">NFTs Owned</h2>
            <div id="ownedNfts" class="owned_grid"></div>
        </div>
    </div>
    <!-- Simple NFT popup for public profile -->
    <div id="nftPopup" class="popup">
      <div class="popup-content">
        <span class="close">&times;</span>

        <div class="popup_nftdetails">
            <span class="popup_nfttext">NFT Details</span>
        </div>

        <div class="pop_mare">
            <div class="popup_image_wrapper">
                <img id="popupImage" src="" alt="NFT preview">
            </div>
            <div class="pop_detalii">
                <p id="popupCategory"></p>
                <h2 id="popupTitle"></h2>

                <p id="popupDescription"></p>

                <div class="currentPrice">
                    <span id="current_price">Current Price</span>
                    <p id="popupPrice"></p>
                    <span id="aprox">≈ $0.00 USD</span>
                </div>

                <div class="owner_creator_boxes">
                    <div class="owner_box">
                        <span class="label">Owner</span>
                        <span id="popupOwner" class="value">-</span>
                    </div>
                    <div class="creator_box">
                        <span class="label">Creator</span>
                        <span id="popupCreator" class="value">-</span>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>
    <script src="script.js"></script>
    <script src="owner.js"></script>
    <script>
    function getQueryParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
    }
    document.addEventListener("DOMContentLoaded", () => {
        const username = getQueryParam('user');
        const id = getQueryParam('id');
        let url = 'profile_public.php?';
        if (username) url += 'user=' + encodeURIComponent(username);
        else if (id) url += 'id=' + encodeURIComponent(id);
        else {
            document.getElementById('userName').textContent = 'User not found';
            return;
        }
        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('userName').textContent = 'User not found';
                    return;
                }
                document.getElementById('userName').textContent = data.username;
                if (data.is_verified && Number(data.is_verified) === 1) {
                    const check = document.createElement('span');
                    check.innerHTML = ' <svg style="vertical-align:middle;margin-left:4px;" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="10" fill="#10b981"/><path d="M6 10.5L9 13.5L14 8.5" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                    document.getElementById('userName').appendChild(check);
                }
                document.getElementById('userEmail').textContent = data.email;
                document.getElementById('userStatus').textContent = data.status;
                document.getElementById('userRole').textContent = data.role || 'User';
                document.getElementById('userId').textContent = '#' + data.id;
                document.getElementById('userAvatar').textContent = data.username ? data.username.charAt(0).toUpperCase() : '?';
                document.getElementById('walletInput').value = data.wallet || '';
                document.getElementById('profileCard').style.opacity = '1';
                // NFTs
                const ownedSection = document.getElementById('ownedSection');
                const ownedGrid = document.getElementById('ownedNfts');
                if (data.nfts && data.nfts.length > 0) {
                    ownedSection.style.display = 'block';
                    ownedGrid.innerHTML = '';
                    data.nfts.forEach(n => {
                        const d = document.createElement('div');
                        d.className = 'owned_item';
                        d.innerHTML = `<div class="owned_img"><img src="${n.image_url||'img/placeholder.jpg'}" alt="${n.name}"></div><div class="owned_meta"><div class="owned_name">${n.name}</div><div class="owned_price">${n.price} ETH</div></div>`;
                        d.addEventListener('click', () => openOwnedNftPopup(n, data.username));
                        ownedGrid.appendChild(d);
                    });
                } else {
                    ownedSection.style.display = 'none';
                }
            })
            .catch(() => {
                document.getElementById('userName').textContent = 'User not found';
            });
    });

    // helper to open NFT popup from public owned list
    function openOwnedNftPopup(nft, username) {
        const popup = document.getElementById('nftPopup');
        if (!popup) return;
        const popupTitle = document.getElementById('popupTitle');
        const popupCategory = document.getElementById('popupCategory');
        const popupDescription = document.getElementById('popupDescription');
        const popupPrice = document.getElementById('popupPrice');
        const popupImg = document.getElementById('popupImage');
        const popupOwner = document.getElementById('popupOwner');
        const popupCreator = document.getElementById('popupCreator');
        const aproxEl = document.getElementById('aprox');

        popupTitle.textContent = nft.name || '';
        popupCategory.textContent = nft.category || '';
        popupDescription.textContent = nft.description || '';
        popupPrice.textContent = (nft.price || 0) + ' ETH';
        popupImg.src = nft.image_url || 'img/placeholder.jpg';

        const ownerNameRaw = username || '';
        const creatorNameRaw = nft.creator_name || ownerNameRaw || '';

        if (popupOwner) {
            popupOwner.textContent = ownerNameRaw || '—';
            popupOwner.style.cursor = 'default';
            popupOwner.onclick = null;
        }

        if (popupCreator) {
            popupCreator.textContent = creatorNameRaw || '—';
            popupCreator.style.cursor = 'default';
            popupCreator.onclick = null;
        }

        const ethVal = parseFloat(nft.price) || 0;
        const rate = 1900;
        if (aproxEl) {
            aproxEl.textContent = '≈ $' + (ethVal * rate).toFixed(2) + ' USD';
        }

        popup.classList.add('show');
    }

    // Popup close logic for public profile
    document.addEventListener('DOMContentLoaded', () => {
        const popup = document.getElementById('nftPopup');
        if (!popup) return;
        const closeBtn = popup.querySelector('.close');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                popup.classList.remove('show');
            });
        }
        window.addEventListener('click', (e) => {
            if (e.target === popup) {
                popup.classList.remove('show');
            }
        });
    });
    </script>
</body>
</html>
