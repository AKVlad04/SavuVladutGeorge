<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="profile.css">
    <title>My Profile - Nexus</title>
    <script src="script.js" defer></script>
    <script src="owner.js" defer></script>
</head>
<body class="profile_owner_page">

    <header class="top_bar">
        <a href="index.html" class="logo">
            <span class="nexus_logo">N</span>
            <span class="nexus">Nexus</span>
        </a>   
        <div class="buttons_footer">
            <a href="index.html" class="home_button">Home</a>
            <a href="explore.html" class="explore_button">Explore</a>
               <a href="wishlist.html" class="wishlist_button">Wishlist</a>
            <a href="trade.html" class="trades_button">Trades</a>
            <a href="create.html" class="create_button">Mint</a>
            <a href="profile.html" class="profile_button">Profile</a>
            <a href="dashboard.html" id="ownerDashboardLink" class="profile_button" style="visibility:hidden">Dashboard</a>
        </div>
        <a href="logout.php" class="connect_wallet" style="border-color: #ef4444;">
            <span class="connect_wallet_text" style="color: #ef4444;">Logout</span>
        </a>
    </header>

    <div class="profile_page">
        <div class="profile_card" id="profileCard" style="opacity: 0; transition: opacity 0.5s;">

            <div class="profile_card_main">
                <div class="profile_main_left">
                    <div class="profile_avatar" id="userAvatar">?</div>
                    <h1 class="profile_name" id="userName">Loading...</h1>
                    <span class="profile_email" id="userEmail">...</span>

                    <div class="profile_actions">
                        <button id="accountSettingsBtn" class="account_btn">Account settings</button>
                        <a href="logout.php" class="logout_btn">Sign Out</a>
                    </div>

                    <button id="getVerifiedBtn" class="verify_btn profile_verify_btn">Get Verified</button>
                </div>

                <div class="profile_main_right">
                    <div class="profile_stats">
                        <div class="stat_box">
                            <span class="stat_value" id="userRole">...</span>
                            <span class="stat_label">Role</span>
                        </div>
                        <div class="stat_box">
                            <span class="stat_value" id="userStatus" style="color: #10b981;">...</span>
                            <span class="stat_label">Status</span>
                        </div>
                        <div class="stat_box">
                            <span class="stat_value" id="userId">#0</span>
                            <span class="stat_label">ID</span>
                        </div>
                    </div>

                    <div class="wallet_row">
                        <label for="walletInput">Wallet address</label>
                        <div class="wallet_controls">
                            <input type="text" id="walletInput" placeholder="0x..." />
                            <button id="saveWallet">Save</button>
                        </div>
                        <p id="saveStatus" style="display:none"></p>
                    </div>

                    <div class="balance_row">
                        <label for="balanceDisplay">Account balance</label>
                        <div class="balance_controls">
                            <input type="text" id="balanceDisplay" value="0.0000 ETH" readonly />
                            <button id="depositBtn">Deposit</button>
                            <button id="withdrawBtn">Withdraw</button>
                        </div>
                        <p id="balanceStatus" style="display:none"></p>
                    </div>

                    <div class="nft_stats_row">
                        <div class="nft_stat_box">
                            <span class="nft_stat_label">Collected</span>
                            <span class="nft_stat_value" id="statCollected">0</span>
                        </div>
                        <div class="nft_stat_box">
                            <span class="nft_stat_label">Created</span>
                            <span class="nft_stat_value" id="statCreated">0</span>
                        </div>
                        <div class="nft_stat_box">
                            <span class="nft_stat_label">Total Value</span>
                            <span class="nft_stat_value" id="statTotalValue">0 ETH</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
			<div class="profile_tabs_container" id="profileTabsContainer" style="width:100%; max-width:1100px; margin-top:30px; display:none">
				<div class="profile_tabs">
					<button class="profile_tab active" data-tab="collected">Collected</button>
                    <button class="profile_tab" data-tab="created">Created</button>
                    <button class="profile_tab" data-tab="offers">Offers</button>
                    <button class="profile_tab" data-tab="activity">Activity</button>
				</div>
				<div class="profile_tab_panels">
					<div class="profile_tab_panel active" data-tab="collected">
                        <div id="collectedGrid" class="nfts"></div>
					</div>
					<div class="profile_tab_panel" data-tab="created">
                        <div id="createdGrid" class="nfts"></div>
					</div>
                    <div class="profile_tab_panel" data-tab="offers">
                        <h3 class="offers_section_title">Offers received on your NFTs</h3>
                        <div id="offersList" class="offers_list"></div>
                        <h3 class="offers_section_title" style="margin-top:24px;">Offers you sent</h3>
                        <div id="sentOffersList" class="offers_list"></div>
                    </div>
                    <div class="profile_tab_panel" data-tab="activity">
                        <div class="activity_filters_bar">
                            <div class="activity_filter_group">
                                <label for="activityTypeFilter">Type</label>
                                <select id="activityTypeFilter">
                                    <option value="">All</option>
                                    <option value="deposit">Deposits</option>
                                    <option value="withdraw">Withdrawals</option>
                                    <option value="offers">Offers (placed/refunded)</option>
                                    <option value="trades">Trades (bought/sold)</option>
                                </select>
                            </div>
                            <div class="activity_filter_group">
                                <label for="activitySearch">Search</label>
                                <input type="text" id="activitySearch" placeholder="Search by NFT name" />
                            </div>
                            <div class="activity_filter_actions">
                                <button type="button" id="activityExportBtn">Export CSV</button>
                            </div>
                        </div>
                        <div id="activityList" class="activity_list"></div>
                    </div>
				</div>
			</div>
    </div>

    <!-- NFT Details Popup (same layout as Explore) -->
    <div id="nftPopup" class="popup">
      <div class="popup-content">
        <span class="close">&times;</span>

        <div class="popup_nftdetails">
            <span class="popup_nfttext">NFT Details</span>
        </div>

        <div class="pop_mare">
            <div class="popup_image_wrapper">
                <img id="popupImage" src="" alt="NFT preview">
                <div class="popup_image_actions">
                    <button id="sendRequestBtn" class="btn btn-primary">Send Request</button>
                    <button id="wishlistBtn" class="btn btn-secondary wishlist-btn" aria-pressed="false" title="Add to wishlist">
                        <svg class="wishlist-heart" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="pop_detalii">
                <p id="popupCategory"></p>
                <h2 id="popupTitle"></h2>

                <div class="views_pop">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon_eye">
                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <span class="views">2.4k views</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon_heart">
                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
                    </svg>
                    <span class="likes">567 likes</span>
                </div>

                <p id="popupDescription"></p>

                <div class="currentPrice">
                    <span id="current_price">Current Price</span>
                    <p id="popupPrice"></p>
                    <span id="aprox">≈ $0.00 USD</span>
                </div>

                <div class="owner_creator_boxes">
                    <div class="owner_box">
                        <span class="label">Owner</span>
                        <span id="popupOwner" class="value">-</span>
                    </div>
                    <div class="creator_box">
                        <span class="label">Creator</span>
                        <span id="popupCreator" class="value">-</span>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>

    <!-- Offer modal: make a price offer on an NFT -->
    <div id="offerModal" class="offer_modal_overlay">
        <div class="offer_modal">
            <button type="button" class="offer_modal_close">&times;</button>
            <h3 class="offer_modal_title">Make an offer</h3>
            <p id="offerModalNft" class="offer_modal_nft"></p>
            <div class="offer_field">
                    <label for="offerPriceInput">Offer price (ETH)</label>
                    <input type="number" id="offerPriceInput" min="0" step="0.0001" placeholder="0.0000" />
            </div>
            <div id="offerStatus" class="offer_status"></div>
            <button id="offerConfirmBtn" class="offer_confirm_btn">Send offer</button>
        </div>
    </div>

    <div id="verifyModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:9999;align-items:center;justify-content:center;">
        <div style="background:#23272f;padding:32px 28px;border-radius:16px;max-width:350px;width:90vw;color:#fff;box-shadow:0 4px 24px #000a;display:flex;flex-direction:column;align-items:center;">
            <div id="verifyModalMsg" style="margin-bottom:18px;font-size:1.1em;text-align:center;"></div>
            <button id="verifyModalOk" class="verify_btn" style="margin-top:8px;">OK</button>
        </div>
    </div>

    <div id="accountModal" class="account_modal_overlay">
        <div class="account_modal">
            <button type="button" class="account_modal_close">&times;</button>
            <h3 class="account_modal_title">Account settings</h3>

            <div class="account_row">
                <div class="account_field">
                    <label for="displayNameInput">Display name</label>
                    <div class="wallet_controls">
                        <input type="text" id="displayNameInput" placeholder="Your username" />
                        <button id="saveDisplayName">Save</button>
                    </div>
                </div>

                <div class="account_field">
                    <label>Change password</label>
                    <div class="password_grid">
                        <input type="password" id="currentPassword" placeholder="Current password" />
                        <input type="password" id="newPassword" placeholder="New password" />
                        <input type="password" id="confirmPassword" placeholder="Confirm new password" />
                        <button id="savePassword">Update password</button>
                    </div>
                </div>

                <div class="account_field">
                    <label for="avatarInput">Profile picture</label>
                    <div class="avatar_controls">
                        <input type="file" id="avatarInput" accept="image/png,image/jpeg,image/gif,image/webp" />
                        <button id="saveAvatar">Upload</button>
                    </div>
                    <p id="accountStatus" style="display:none"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="balanceModal" class="balance_modal_overlay">
        <div class="balance_modal">
            <button type="button" class="balance_modal_close">&times;</button>
            <h3 id="balanceModalTitle" class="balance_modal_title">Deposit ETH</h3>
            <div class="balance_field">
                <label for="balanceAmountInput">Amount (ETH)</label>
                <input type="number" id="balanceAmountInput" min="0" step="0.0001" placeholder="0.0000" />
                <button id="balanceMaxBtn" type="button" class="balance_max_btn">Max</button>
            </div>
            <button id="balanceConfirmBtn" class="balance_confirm_btn">Confirm</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            fetch('get_profile.php')
                .then(response => response.json())
                .then(data => {
                    if (data.logged_in) {
                        document.getElementById('userName').textContent = data.username;
                        // Show checkmark if verified
                        if (data.is_verified && Number(data.is_verified) === 1) {
                            const check = document.createElement('span');
                            check.innerHTML = ' <svg style="vertical-align:middle;margin-left:4px;" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="10" fill="#10b981"/><path d="M6 10.5L9 13.5L14 8.5" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                            document.getElementById('userName').appendChild(check);
                            // Hide verify button if present
                            const verifyBtn = document.getElementById('getVerifiedBtn');
                            if (verifyBtn) verifyBtn.style.display = 'none';
                        } else {
                            // Check for pending/rejected verification request
                            fetch('get_verification_status.php')
                                .then(r => r.json())
                                .then(vs => {
                                    const verifyBtn = document.getElementById('getVerifiedBtn');
                                    if (!verifyBtn) return;
                                    if (vs.status === 'pending') {
                                        verifyBtn.textContent = 'Verification Pending';
                                        verifyBtn.disabled = false;
                                        verifyBtn.classList.add('btn-disabled');
                                        verifyBtn.style.opacity = 0.8;
                                        verifyBtn.onclick = function() {
                                            showVerifyModal('Your verification request is pending review. Please wait for an admin to approve or reject your request.');
                                        };
                                    } else if (vs.status === 'approved') {
                                        verifyBtn.style.display = 'none';
                                        // Optionally, show checkmark (already handled above)
                                    } else if (vs.status === 'rejected') {
                                        verifyBtn.textContent = 'Verification Rejected';
                                        verifyBtn.disabled = false;
                                        verifyBtn.classList.add('btn-disabled');
                                        verifyBtn.style.opacity = 0.8;
                                        verifyBtn.onclick = function() {
                                            showVerifyModal('Your verification request was rejected. You can submit a new request.');
                                        };
                                    } else {
                                        verifyBtn.textContent = 'Get Verified';
                                        verifyBtn.disabled = false;
                                        verifyBtn.classList.remove('btn-disabled');
                                        verifyBtn.style.opacity = 1;
                                        verifyBtn.onclick = function() {
                                            window.location.href = 'verify.html';
                                        };
                                    }
                                });
                        }
                        document.getElementById('userEmail').textContent = data.email;
                        document.getElementById('userStatus').textContent = data.status;
                        document.getElementById('userRole').textContent = data.role || 'User';
                        document.getElementById('userId').textContent = "#" + data.id;
                        const avatarEl = document.getElementById('userAvatar');
                        if (data.avatar_url) {
                            avatarEl.style.backgroundImage = 'url(' + data.avatar_url + ')';
                            avatarEl.style.backgroundSize = 'cover';
                            avatarEl.style.backgroundPosition = 'center';
                            avatarEl.textContent = '';
                        } else {
                            avatarEl.textContent = data.initial;
                        }
                        
                        // Store current user id globally for offer role logic
                        window.__currentUserId = data.id;

                        // Expune id-ul utilizatorului logat pentru logica de oferte
                        window.__currentUserId = data.id;

                        // Balanță cont ETH (imaginară)
                        const balanceDisplay = document.getElementById('balanceDisplay');
                        const balanceStatus = document.getElementById('balanceStatus');
                        let currentBalance = (typeof data.balance_eth !== 'undefined' && data.balance_eth !== null)
                            ? parseFloat(data.balance_eth)
                            : 0;
                        if (isNaN(currentBalance)) currentBalance = 0;

                        function updateBalanceUI() {
                            if (balanceDisplay) {
                                balanceDisplay.value = currentBalance.toFixed(4) + ' ETH';
                            }
                        }

                        updateBalanceUI();

                        // Facem cardul vizibil
                        document.getElementById('profileCard').style.opacity = '1';

                        // helper to open NFT popup from profile lists
                        function openOwnedNftPopup(nft, username) {
                            const popup = document.getElementById('nftPopup');
                            if (!popup) return;
                            const popupTitle = document.getElementById('popupTitle');
                            const popupCategory = document.getElementById('popupCategory');
                            const popupDescription = document.getElementById('popupDescription');
                            const popupPrice = document.getElementById('popupPrice');
                            const popupImg = document.getElementById('popupImage');
                            const popupOwner = document.getElementById('popupOwner');
                            const popupCreator = document.getElementById('popupCreator');
                            const sendRequestBtn = document.getElementById('sendRequestBtn');
                            const wishlistBtn = document.getElementById('wishlistBtn');
                            const aproxEl = document.getElementById('aprox');

                            popupTitle.textContent = nft.name || '';
                            popupCategory.textContent = nft.category || '';
                            popupDescription.textContent = nft.description || '';
                            popupPrice.textContent = (nft.price || 0) + ' ETH';
                            popupImg.src = nft.image_url || 'img/placeholder.jpg';

                            const ownerNameRaw = nft.owner_name || (nft.owner_id ? ('User #' + nft.owner_id) : '');
                            const creatorNameRaw = nft.creator_name || (nft.creator_id ? ('User #' + nft.creator_id) : '');

                            if (popupOwner) {
                                popupOwner.textContent = ownerNameRaw || '—';
                                popupOwner.style.cursor = ownerNameRaw ? 'pointer' : 'default';
                                popupOwner.onclick = null;
                                if (ownerNameRaw && !ownerNameRaw.startsWith('User #')) {
                                    popupOwner.onclick = () => {
                                        const current = window.currentUsername || (data && data.username) || null;
                                        if (current && current.toLowerCase() === ownerNameRaw.toLowerCase()) {
                                            window.location.href = 'profile.html';
                                        } else {
                                            window.location.href = 'profile_public.html?user=' + encodeURIComponent(ownerNameRaw);
                                        }
                                    };
                                }
                            }

                            if (popupCreator) {
                                popupCreator.textContent = creatorNameRaw || '—';
                                popupCreator.style.cursor = creatorNameRaw ? 'pointer' : 'default';
                                popupCreator.onclick = null;
                                if (creatorNameRaw && !creatorNameRaw.startsWith('User #')) {
                                    popupCreator.onclick = () => {
                                        const current = window.currentUsername || (data && data.username) || null;
                                        if (current && current.toLowerCase() === creatorNameRaw.toLowerCase()) {
                                            window.location.href = 'profile.html';
                                        } else {
                                            window.location.href = 'profile_public.html?user=' + encodeURIComponent(creatorNameRaw);
                                        }
                                    };
                                }
                            }

                            const ethVal = parseFloat(nft.price) || 0;
                            const rate = 1900; // fallback USD per ETH
                            if (aproxEl) {
                                aproxEl.textContent = '≈ $' + (ethVal * rate).toFixed(2) + ' USD';
                            }

                            // Configure Send Request / Place Sell button
                            if (sendRequestBtn && nft.id) {
                                const isOwner = nft.owner_id && Number(nft.owner_id) === Number(data.id);
                                sendRequestBtn.onclick = null;
                                if (isOwner) {
                                    sendRequestBtn.textContent = 'Place Sell';
                                    sendRequestBtn.onclick = () => {
                                        const url = 'trade.html?nft_id=' + encodeURIComponent(nft.id);
                                        window.location.href = url;
                                    };
                                } else if (typeof openOfferModal === 'function') {
                                    sendRequestBtn.textContent = 'Send offer';
                                    sendRequestBtn.onclick = (e) => {
                                        e.preventDefault();
                                        openOfferModal(nft);
                                    };
                                }
                            }

                            // Configure wishlist button in popup
                            if (wishlistBtn && nft.id) {
                                wishlistBtn.disabled = false;
                                fetch('wishlist_status.php?nft_id=' + encodeURIComponent(nft.id))
                                    .then(r => r.json())
                                    .then(st => {
                                        const inW = st && st.in_wishlist;
                                        wishlistBtn.classList.toggle('active', !!inW);
                                        wishlistBtn.setAttribute('aria-pressed', inW ? 'true' : 'false');
                                        const allCardBtns = document.querySelectorAll('.card-wishlist-btn[data-nft-id="' + nft.id + '"]');
                                        allCardBtns.forEach(btn => {
                                            btn.classList.toggle('active', !!inW);
                                            btn.setAttribute('aria-pressed', inW ? 'true' : 'false');
                                        });
                                    })
                                    .catch(() => {});

                                wishlistBtn.onclick = async () => {
                                    try {
                                        const resp = await fetch('wishlist_toggle.php', {
                                            method: 'POST',
                                            headers: {'Content-Type':'application/json'},
                                            body: JSON.stringify({nft_id: nft.id})
                                        });
                                        const dataToggle = await resp.json();
                                        if (dataToggle && dataToggle.error === 'not_logged_in') {
                                            window.location.href = 'login.html';
                                            return;
                                        }
                                        if (dataToggle && dataToggle.ok) {
                                            const inW = !!dataToggle.in_wishlist;
                                            wishlistBtn.classList.toggle('active', inW);
                                            wishlistBtn.setAttribute('aria-pressed', inW ? 'true' : 'false');
                                            const allCardBtns = document.querySelectorAll('.card-wishlist-btn[data-nft-id="' + nft.id + '"]');
                                            allCardBtns.forEach(btn => {
                                                btn.classList.toggle('active', inW);
                                                btn.setAttribute('aria-pressed', inW ? 'true' : 'false');
                                            });
                                        }
                                    } catch(e2) {
                                        console.error('profile popup wishlist toggle failed', e2);
                                    }
                                };
                            }

                            popup.classList.add('show');
                        }

                        function renderProfileNftGrid(gridEl, list, emptyMsg) {
                            if (!gridEl) return;
                            gridEl.innerHTML = '';
                            if (!Array.isArray(list) || list.length === 0) {
                                const p = document.createElement('p');
                                p.className = 'empty_msg';
                                p.textContent = emptyMsg;
                                gridEl.appendChild(p);
                                return;
                            }
                            list.forEach(n => {
                                const card = document.createElement('div');
                                card.className = 'nft';
                                card.innerHTML = `
                                    <div class="nft_image">
                                        <img src="${n.image_url||'img/placeholder.jpg'}" alt="${n.name}">
                                        <button class="card-wishlist-btn" type="button" data-nft-id="${n.id}" aria-pressed="false" title="Add to wishlist">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="nft_footer">
                                        <div class="nft_name_cat">
                                            <span class="nft_name">${n.name}</span>
                                            <span class="nft_category">${n.category||''}</span>
                                            <span class="nft_price">${n.price} ETH</span>
                                        </div>
                                    </div>
                                `;

                                const cardWishlistBtn = card.querySelector('.card-wishlist-btn');
                                if (cardWishlistBtn && n.id) {
                                    fetch('wishlist_status.php?nft_id=' + encodeURIComponent(n.id))
                                        .then(r => r.json())
                                        .then(st => {
                                            if (st && st.in_wishlist) {
                                                cardWishlistBtn.classList.add('active');
                                                cardWishlistBtn.setAttribute('aria-pressed', 'true');
                                            } else {
                                                cardWishlistBtn.classList.remove('active');
                                                cardWishlistBtn.setAttribute('aria-pressed', 'false');
                                            }
                                        })
                                        .catch(() => {});

                                    cardWishlistBtn.addEventListener('click', async (e) => {
                                        e.stopPropagation();
                                        try {
                                            const resp = await fetch('wishlist_toggle.php', {
                                                method: 'POST',
                                                headers: {'Content-Type':'application/json'},
                                                body: JSON.stringify({nft_id: n.id})
                                            });
                                            const dataToggle = await resp.json();
                                            if (dataToggle && dataToggle.error === 'not_logged_in') {
                                                window.location.href = 'login.html';
                                                return;
                                            }
                                            if (dataToggle && dataToggle.ok) {
                                                const inW = !!dataToggle.in_wishlist;
                                                const allCardBtns = document.querySelectorAll('.card-wishlist-btn[data-nft-id="' + n.id + '"]');
                                                allCardBtns.forEach(btn => {
                                                    btn.classList.toggle('active', inW);
                                                    btn.setAttribute('aria-pressed', inW ? 'true' : 'false');
                                                });

                                                const popup = document.getElementById('nftPopup');
                                                const popupTitle = document.getElementById('popupTitle');
                                                const wishlistBtnPopup = document.getElementById('wishlistBtn');
                                                if (popup && popup.classList.contains('show') && wishlistBtnPopup && popupTitle && popupTitle.textContent === (n.name || '')) {
                                                    wishlistBtnPopup.classList.toggle('active', inW);
                                                    wishlistBtnPopup.setAttribute('aria-pressed', inW ? 'true' : 'false');
                                                }
                                            }
                                        } catch(e2) {
                                            console.error('profile card wishlist toggle failed', e2);
                                        }
                                    });
                                }

                                card.addEventListener('click', () => openOwnedNftPopup(n, data.username));
                                gridEl.appendChild(card);
                            });
                        }

                        function initProfileTabs() {
                            const tabButtons = document.querySelectorAll('.profile_tab');
                            const panels = document.querySelectorAll('.profile_tab_panel');
                            tabButtons.forEach(btn => {
                                btn.addEventListener('click', () => {
                                    const target = btn.getAttribute('data-tab');
                                    tabButtons.forEach(b => b.classList.remove('active'));
                                    btn.classList.add('active');
                                    panels.forEach(p => {
                                        if (p.getAttribute('data-tab') === target) {
                                            p.classList.add('active');
                                        } else {
                                            p.classList.remove('active');
                                        }
                                    });

                                    if (target === 'activity') {
                                        loadActivityList();
                                    }
                                    if (target === 'offers') {
                                        loadOffersList();
                                        if (typeof loadSentOffersList === 'function') {
                                            loadSentOffersList();
                                        }
                                    }
                                });
                            });
                        }

                        initProfileTabs();

                        let activityItemsCache = [];

                        function renderActivityList() {
                            const activityList = document.getElementById('activityList');
                            if (!activityList) return;
                            activityList.innerHTML = '';

                            if (!Array.isArray(activityItemsCache) || activityItemsCache.length === 0) {
                                const p = document.createElement('p');
                                p.className = 'empty_msg';
                                p.textContent = 'No balance activity yet.';
                                activityList.appendChild(p);
                                return;
                            }

                            const typeSel = document.getElementById('activityTypeFilter');
                            const searchInput = document.getElementById('activitySearch');
                            const typeVal = typeSel ? typeSel.value : '';
                            const searchVal = searchInput ? String(searchInput.value || '').trim().toLowerCase() : '';

                            const filtered = activityItemsCache.filter(item => {
                                // type filter
                                if (typeVal === 'deposit' && item.type !== 'deposit') return false;
                                if (typeVal === 'withdraw' && item.type !== 'withdraw') return false;
                                if (typeVal === 'offers') {
                                    // offers: deposit/withdraw with nft_id
                                    if (!(item.nft_id && (item.type === 'deposit' || item.type === 'withdraw'))) return false;
                                }
                                if (typeVal === 'trades') {
                                    if (!(item.type === 'buy' || item.type === 'sell')) return false;
                                }

                                // search filter (by nft_name text)
                                if (searchVal) {
                                    const name = (item.nft_name || '').toLowerCase();
                                    if (!name.includes(searchVal)) return false;
                                }

                                return true;
                            });

                            if (filtered.length === 0) {
                                const p = document.createElement('p');
                                p.className = 'empty_msg';
                                p.textContent = 'No activity matching current filters.';
                                activityList.appendChild(p);
                                return;
                            }

                            filtered.forEach(item => {
                                const row = document.createElement('div');

                                let kindClass = 'activity_deposit';
                                if (item.type === 'withdraw') kindClass = 'activity_withdraw';
                                if (item.type === 'buy') kindClass = 'activity_withdraw';
                                if (item.type === 'sell') kindClass = 'activity_deposit';

                                row.className = 'activity_item ' + kindClass;

                                const left = document.createElement('div');
                                left.className = 'activity_left';

                                const title = document.createElement('div');
                                title.className = 'activity_title';
                                if (item.type === 'deposit') {
                                    if (item.nft_id) {
                                        title.textContent = 'Offer refund for' + (item.nft_name ? ' ' + item.nft_name : '');
                                    } else {
                                        title.textContent = 'Deposit';
                                    }
                                } else if (item.type === 'withdraw') {
                                    if (item.nft_id) {
                                        title.textContent = 'Offer placed on' + (item.nft_name ? ' ' + item.nft_name : '');
                                    } else {
                                        title.textContent = 'Withdrawal';
                                    }
                                } else if (item.type === 'buy') {
                                    title.textContent = 'Bought' + (item.nft_name ? ' ' + item.nft_name : '');
                                } else if (item.type === 'sell') {
                                    title.textContent = 'Sold' + (item.nft_name ? ' ' + item.nft_name : '');
                                } else {
                                    title.textContent = item.type;
                                }

                                const date = document.createElement('div');
                                date.className = 'activity_date';
                                date.textContent = item.created_at || '';

                                left.appendChild(title);
                                left.appendChild(date);

                                const right = document.createElement('div');
                                right.className = 'activity_amount';
                                let sign = '+';
                                if (item.type === 'withdraw' || item.type === 'buy') sign = '-';
                                const amountVal = parseFloat(item.amount) || 0;
                                right.textContent = sign + amountVal.toFixed(4) + ' ETH';

                                row.appendChild(left);
                                row.appendChild(right);
                                activityList.appendChild(row);
                            });
                        }

                        function loadActivityList() {
                            fetch('get_balance_activity.php')
                                .then(r => r.ok ? r.json() : Promise.reject())
                                .then(act => {
                                    if (!act || !act.ok || !Array.isArray(act.items)) {
                                        activityItemsCache = [];
                                    } else {
                                        activityItemsCache = act.items;
                                    }
                                    renderActivityList();

                                    // asigură-te că filtrele Activity reacționează la input
                                    const typeSel = document.getElementById('activityTypeFilter');
                                    const searchInput = document.getElementById('activitySearch');
                                    const exportBtn = document.getElementById('activityExportBtn');

                                    if (typeSel && !typeSel._boundActivityChange) {
                                        typeSel.addEventListener('change', renderActivityList);
                                        typeSel._boundActivityChange = true;
                                    }
                                    if (searchInput && !searchInput._boundActivityInput) {
                                        searchInput.addEventListener('input', renderActivityList);
                                        searchInput._boundActivityInput = true;
                                    }
                                    if (exportBtn && !exportBtn._boundActivityExport) {
                                        exportBtn.addEventListener('click', () => {
                                            if (!Array.isArray(activityItemsCache) || activityItemsCache.length === 0) {
                                                alert('No activity to export.');
                                                return;
                                            }
                                            // CSV head
                                            const header = ['type','amount','balance_after','created_at','nft_id','nft_name'];
                                            const rows = activityItemsCache.map(it => [
                                                it.type || '',
                                                (typeof it.amount !== 'undefined' ? String(it.amount) : ''),
                                                (typeof it.balance_after !== 'undefined' ? String(it.balance_after) : ''),
                                                it.created_at || '',
                                                (typeof it.nft_id !== 'undefined' && it.nft_id !== null ? String(it.nft_id) : ''),
                                                it.nft_name || ''
                                            ]);

                                            const escapeCsv = (val) => {
                                                if (val == null) return '';
                                                const s = String(val);
                                                if (s.includes('"') || s.includes(',') || s.includes('\n') || s.includes('\r')) {
                                                    return '"' + s.replace(/"/g, '""') + '"';
                                                }
                                                return s;
                                            };

                                            const lines = [header.map(escapeCsv).join(',')].concat(
                                                rows.map(r => r.map(escapeCsv).join(','))
                                            );
                                            const csvContent = lines.join('\r\n');

                                            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = 'activity_history.csv';
                                            document.body.appendChild(a);
                                            a.click();
                                            document.body.removeChild(a);
                                            URL.revokeObjectURL(url);
                                        });
                                        exportBtn._boundActivityExport = true;
                                    }
                                })
                                .catch(() => {
                                    activityItemsCache = [];
                                    renderActivityList();
                                });
                        }

                        // Helper pentru a reîncărca NFT-urile și statisticile profilului
                        function reloadProfileNftsSection() {
                            fetch('nfts.php').then(r=>r.json()).then(nfts=>{
                                if (!Array.isArray(nfts)) return;

                                const collected = nfts.filter(n => n.owner_id && Number(n.owner_id) === Number(data.id));
                                const created = nfts.filter(n => n.creator_id && Number(n.creator_id) === Number(data.id));

                                const collectedCountEl = document.getElementById('statCollected');
                                const createdCountEl = document.getElementById('statCreated');
                                const totalValueEl = document.getElementById('statTotalValue');

                                const totalValue = collected.reduce((sum, n) => sum + (parseFloat(n.price) || 0), 0);

                                if (collectedCountEl) collectedCountEl.textContent = collected.length;
                                if (createdCountEl) createdCountEl.textContent = created.length;
                                if (totalValueEl) totalValueEl.textContent = totalValue.toFixed(2) + ' ETH';

                                const collectedGrid = document.getElementById('collectedGrid');
                                const createdGrid = document.getElementById('createdGrid');

                                renderProfileNftGrid(collectedGrid, collected, 'No collected NFTs yet.');
                                renderProfileNftGrid(createdGrid, created, 'No created NFTs yet.');
                            }).catch(()=>{});
                        }

                        function loadOffersList() {
                            const offersList = document.getElementById('offersList');
                            if (!offersList) return;
                            offersList.innerHTML = '';
                            fetch('get_offers.php')
                                .then(r => r.ok ? r.json() : Promise.reject())
                                .then(payload => {
                                    if (!payload || !payload.ok || !Array.isArray(payload.items) || payload.items.length === 0) {
                                        const p = document.createElement('p');
                                        p.className = 'empty_msg';
                                        p.textContent = 'No offers yet.';
                                        offersList.appendChild(p);
                                        return;
                                    }

                                    payload.items.forEach(of => {
                                        const row = document.createElement('div');
                                        row.className = 'offer_item';

                                        const left = document.createElement('div');
                                        left.className = 'offer_left';

                                        const thumbWrap = document.createElement('div');
                                        thumbWrap.className = 'offer_thumb';
                                        const img = document.createElement('img');
                                        img.src = of.image_url || 'img/placeholder.jpg';
                                        img.alt = of.nft_name || 'NFT';
                                        thumbWrap.appendChild(img);

                                        const info = document.createElement('div');
                                        info.className = 'offer_info';
                                        const title = document.createElement('div');
                                        title.className = 'offer_title';
                                        title.textContent = of.nft_name || 'Untitled NFT';
                                        const buyer = document.createElement('div');
                                        buyer.className = 'offer_buyer';
                                        // If current user is seller, this is an offer from buyer.
                                        // If current user is buyer (counter-offer received), this shows who is selling.
                                        if (of.seller_id && of.buyer_id && window.__currentUserId) {
                                            const me = Number(window.__currentUserId);
                                            if (me === Number(of.seller_id)) {
                                                buyer.textContent = 'From ' + (of.buyer_name || 'Unknown buyer');
                                            } else if (me === Number(of.buyer_id)) {
                                                buyer.textContent = 'From ' + (of.seller_name || 'Unknown owner');
                                            } else {
                                                buyer.textContent = 'From ' + (of.buyer_name || 'Unknown user');
                                            }
                                        } else {
                                            buyer.textContent = 'From ' + (of.buyer_name || 'Unknown user');
                                        }
                                        const meta = document.createElement('div');
                                        meta.className = 'offer_meta';
                                        const priceVal = parseFloat(of.price) || 0;
                                        meta.textContent = priceVal.toFixed(4) + ' ETH';

                                        info.appendChild(title);
                                        info.appendChild(buyer);
                                        info.appendChild(meta);

                                        left.appendChild(thumbWrap);
                                        left.appendChild(info);

                                        const right = document.createElement('div');
                                        right.className = 'offer_right';
                                        const status = document.createElement('span');
                                        status.className = 'offer_status_badge offer_status_' + (of.status || 'open');
                                        status.textContent = (of.status || 'open').charAt(0).toUpperCase() + (of.status || 'open').slice(1);
                                        const date = document.createElement('div');
                                        date.className = 'offer_date';
                                        date.textContent = of.created_at || '';
                                        right.appendChild(status);
                                        right.appendChild(date);

                                        // Actions (accept / reject / counter) only for open offers
                                        if (of.status === 'open') {
                                            const actions = document.createElement('div');
                                            actions.className = 'offer_actions';
                                            const me = window.__currentUserId ? Number(window.__currentUserId) : null;

                                            const btnAccept = document.createElement('button');
                                            btnAccept.className = 'offer_btn offer_btn_accept';
                                            btnAccept.textContent = 'Accept';

                                            const btnReject = document.createElement('button');
                                            btnReject.className = 'offer_btn offer_btn_reject';
                                            btnReject.textContent = 'Reject';

                                            const btnCounter = document.createElement('button');
                                            btnCounter.className = 'offer_btn offer_btn_reject';
                                            btnCounter.textContent = 'Counter';

                                            const setBusy = (busy) => {
                                                btnAccept.disabled = busy;
                                                btnReject.disabled = busy;
                                                btnCounter.disabled = busy;
                                            };

                                            // Determine who initiated this offer: buyer (funds_reserved=1, parent_offer_id null) or seller (counter-offer).
                                            const isBuyerInitiated = (Number(of.funds_reserved) === 1 && (of.parent_offer_id === null || of.parent_offer_id === undefined));

                                            // For buyer-initiated offers, only seller (nft owner) can accept/reject and may send counter.
                                            // For seller counter-offers, only buyer can accept/reject; seller may cancel from "sent" list, no counter here.

                                            const canRespond = me !== null && (
                                                (isBuyerInitiated && me === Number(of.seller_id)) ||
                                                (!isBuyerInitiated && me === Number(of.buyer_id))
                                            );

                                            if (!canRespond) {
                                                // No actions for this user on this offer (should not really happen with filtered API, but keep safe).
                                            } else {
                                                // Attach accept/reject handlers for both directions.
                                                btnAccept.addEventListener('click', async (e) => {
                                                    e.preventDefault();
                                                    setBusy(true);
                                                    try {
                                                        const resp = await fetch('offer_action.php', {
                                                            method: 'POST',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({ offer_id: of.id, action: 'accept' })
                                                        });
                                                        const data = await resp.json();
                                                        if (!resp.ok || !data || !data.ok) {
                                                            const code = data && data.error ? data.error : 'unknown_error';
                                                            console.error('offer accept failed', code, data && data.details);
                                                            let msg = 'Could not accept offer.';
                                                            if (code === 'insufficient_funds') msg = 'Buyer no longer has enough balance for this offer.';
                                                            if (code === 'not_authorized_for_accept') msg = 'You are not allowed to accept this offer.';
                                                            alert(msg);
                                                        } else {
                                                            loadOffersList();
                                                            if (typeof loadSentOffersList === 'function') {
                                                                loadSentOffersList();
                                                            }
                                                            if (typeof loadActivityList === 'function') {
                                                                loadActivityList();
                                                            }
                                                            // actualizează imediat NFT-urile și statisticile profilului
                                                            reloadProfileNftsSection();
                                                        }
                                                    } catch (err) {
                                                        console.error('offer accept network error', err);
                                                        alert('Network error while accepting offer.');
                                                    } finally {
                                                        setBusy(false);
                                                    }
                                                });

                                                btnReject.addEventListener('click', async (e) => {
                                                    e.preventDefault();
                                                    setBusy(true);
                                                    try {
                                                        const resp = await fetch('offer_action.php', {
                                                            method: 'POST',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({ offer_id: of.id, action: 'reject' })
                                                        });
                                                        const data = await resp.json();
                                                        if (!resp.ok || !data || !data.ok) {
                                                            const code = data && data.error ? data.error : 'unknown_error';
                                                            console.error('offer reject failed', data);
                                                            let msg = 'Could not reject offer.';
                                                            if (code === 'not_authorized_for_reject') msg = 'You are not allowed to reject this offer.';
                                                            alert(msg);
                                                        } else {
                                                            loadOffersList();
                                                            if (typeof loadSentOffersList === 'function') {
                                                                loadSentOffersList();
                                                            }
                                                        }
                                                    } catch (err) {
                                                        console.error('offer reject network error', err);
                                                        alert('Network error while rejecting offer.');
                                                    } finally {
                                                        setBusy(false);
                                                    }
                                                });

                                                // Only seller can send a counter on buyer-initiated offers.
                                                if (isBuyerInitiated && me === Number(of.seller_id)) {
                                                    btnCounter.addEventListener('click', async (e) => {
                                                        e.preventDefault();
                                                        const val = prompt('New counter-offer price (ETH):', of.price);
                                                        if (val === null) return;
                                                        const parsed = parseFloat(String(val).replace(',', '.'));
                                                        if (!parsed || parsed <= 0) {
                                                            alert('Please enter a valid positive price.');
                                                            return;
                                                        }
                                                        setBusy(true);
                                                        try {
                                                            const resp = await fetch('offer_action.php', {
                                                                method: 'POST',
                                                                headers: { 'Content-Type': 'application/json' },
                                                                body: JSON.stringify({ offer_id: of.id, action: 'counter', new_price: parsed })
                                                            });
                                                            const data = await resp.json();
                                                            if (!resp.ok || !data || !data.ok) {
                                                                console.error('offer counter failed', data);
                                                                let msg = 'Could not send counter-offer.';
                                                                if (data && data.error === 'not_seller') msg = 'You are not allowed to counter this offer.';
                                                                alert(msg);
                                                            } else {
                                                                // după counter, oferta inițială dispare din lista de "received",
                                                                // iar noul counter apare în lista de "sent" fără refresh.
                                                                loadOffersList();
                                                                if (typeof loadSentOffersList === 'function') {
                                                                    loadSentOffersList();
                                                                }
                                                                if (typeof loadActivityList === 'function') {
                                                                    loadActivityList();
                                                                }
                                                            }
                                                        } catch (err) {
                                                            console.error('offer counter network error', err);
                                                            alert('Network error while sending counter-offer.');
                                                        } finally {
                                                            setBusy(false);
                                                        }
                                                    });
                                                }

                                                actions.appendChild(btnAccept);
                                                actions.appendChild(btnReject);
                                                if (isBuyerInitiated && me === Number(of.seller_id)) {
                                                    actions.appendChild(btnCounter);
                                                }
                                            }
                                            right.appendChild(actions);
                                        }

                                        row.appendChild(left);
                                        row.appendChild(right);
                                        offersList.appendChild(row);
                                    });
                                })
                                .catch(() => {
                                    const p = document.createElement('p');
                                    p.className = 'empty_msg';
                                    p.textContent = 'Could not load offers.';
                                    offersList.appendChild(p);
                                });
                        }

                        function loadSentOffersList() {
                            const sentList = document.getElementById('sentOffersList');
                            if (!sentList) return;
                            sentList.innerHTML = '';
                            fetch('get_sent_offers.php')
                                .then(r => r.ok ? r.json() : Promise.reject())
                                .then(payload => {
                                    if (!payload || !payload.ok || !Array.isArray(payload.items) || payload.items.length === 0) {
                                        const p = document.createElement('p');
                                        p.className = 'empty_msg';
                                        p.textContent = 'No sent offers yet.';
                                        sentList.appendChild(p);
                                        return;
                                    }

                                    payload.items.forEach(of => {
                                        const row = document.createElement('div');
                                        row.className = 'offer_item';

                                        const left = document.createElement('div');
                                        left.className = 'offer_left';

                                        const thumbWrap = document.createElement('div');
                                        thumbWrap.className = 'offer_thumb';
                                        const img = document.createElement('img');
                                        img.src = of.image_url || 'img/placeholder.jpg';
                                        img.alt = of.nft_name || 'NFT';
                                        thumbWrap.appendChild(img);

                                        const info = document.createElement('div');
                                        info.className = 'offer_info';
                                        const title = document.createElement('div');
                                        title.className = 'offer_title';
                                        title.textContent = of.nft_name || 'Untitled NFT';
                                        const seller = document.createElement('div');
                                        seller.className = 'offer_buyer';
                                        // Sent offers: show counterparty depending on who initiated.
                                        const me = window.__currentUserId ? Number(window.__currentUserId) : null;
                                        const isBuyerInitiated = (Number(of.funds_reserved) === 1 && (of.parent_offer_id === null || of.parent_offer_id === undefined));
                                        if (me !== null && of.seller_id && of.buyer_id) {
                                            if (isBuyerInitiated && me === Number(of.buyer_id)) {
                                                // You are the buyer who initiated; show seller.
                                                seller.textContent = 'To ' + (of.seller_name || 'Unknown owner');
                                            } else if (!isBuyerInitiated && me === Number(of.seller_id)) {
                                                // You are the seller who countered; show buyer.
                                                seller.textContent = 'To ' + (of.buyer_name || 'Unknown buyer');
                                            } else {
                                                seller.textContent = 'To ' + (of.seller_name || 'Unknown user');
                                            }
                                        } else {
                                            seller.textContent = 'To ' + (of.seller_name || 'Unknown owner');
                                        }
                                        const meta = document.createElement('div');
                                        meta.className = 'offer_meta';
                                        const priceVal = parseFloat(of.price) || 0;
                                        meta.textContent = priceVal.toFixed(4) + ' ETH';

                                        info.appendChild(title);
                                        info.appendChild(seller);
                                        info.appendChild(meta);

                                        left.appendChild(thumbWrap);
                                        left.appendChild(info);

                                        const right = document.createElement('div');
                                        right.className = 'offer_right';
                                        const status = document.createElement('span');
                                        status.className = 'offer_status_badge offer_status_' + (of.status || 'open');
                                        status.textContent = (of.status || 'open').charAt(0).toUpperCase() + (of.status || 'open').slice(1);
                                        const date = document.createElement('div');
                                        date.className = 'offer_date';
                                        date.textContent = of.created_at || '';
                                        right.appendChild(status);
                                        right.appendChild(date);

                                        if (of.status === 'open') {
                                            const actions = document.createElement('div');
                                            actions.className = 'offer_actions';

                                            const me2 = window.__currentUserId ? Number(window.__currentUserId) : null;
                                            const isBuyerInitiated2 = (Number(of.funds_reserved) === 1 && (of.parent_offer_id === null || of.parent_offer_id === undefined));

                                            // Only the initiator can cancel: buyer for original offers, seller for counter-offers.
                                            const canCancel = me2 !== null && (
                                                (isBuyerInitiated2 && me2 === Number(of.buyer_id)) ||
                                                (!isBuyerInitiated2 && me2 === Number(of.seller_id))
                                            );

                                            if (canCancel) {
                                                const btnCancel = document.createElement('button');
                                                btnCancel.className = 'offer_btn offer_btn_reject';
                                                btnCancel.textContent = 'Cancel';

                                                const setBusy = (busy) => {
                                                    btnCancel.disabled = busy;
                                                };

                                                btnCancel.addEventListener('click', async (e) => {
                                                    e.preventDefault();
                                                    setBusy(true);
                                                    try {
                                                        const resp = await fetch('offer_action.php', {
                                                            method: 'POST',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({ offer_id: of.id, action: 'cancel' })
                                                        });
                                                        const data = await resp.json();
                                                        if (!resp.ok || !data || !data.ok) {
                                                            console.error('offer cancel failed', data);
                                                            alert('Could not cancel offer.');
                                                        } else {
                                                            loadSentOffersList();
                                                            if (typeof loadActivityList === 'function') {
                                                                loadActivityList();
                                                            }
                                                        }
                                                    } catch (err) {
                                                        console.error('offer cancel network error', err);
                                                        alert('Network error while cancelling offer.');
                                                    } finally {
                                                        setBusy(false);
                                                    }
                                                });

                                                actions.appendChild(btnCancel);
                                            }
                                            right.appendChild(actions);
                                        }

                                        row.appendChild(left);
                                        row.appendChild(right);
                                        sentList.appendChild(row);
                                    });
                                })
                                .catch(() => {
                                    const p = document.createElement('p');
                                    p.className = 'empty_msg';
                                    p.textContent = 'Could not load sent offers.';
                                    sentList.appendChild(p);
                                });
                        }

                        // Load NFTs for profile stats and tabs (prima încărcare)
                        fetch('nfts.php').then(r=>r.json()).then(nfts=>{
                            if (!Array.isArray(nfts)) return;

                            const collected = nfts.filter(n => n.owner_id && Number(n.owner_id) === Number(data.id));
                            const created = nfts.filter(n => n.creator_id && Number(n.creator_id) === Number(data.id));

                            // stats
                            const collectedCountEl = document.getElementById('statCollected');
                            const createdCountEl = document.getElementById('statCreated');
                            const totalValueEl = document.getElementById('statTotalValue');

                            const totalValue = collected.reduce((sum, n) => sum + (parseFloat(n.price) || 0), 0);

                            if (collectedCountEl) collectedCountEl.textContent = collected.length;
                            if (createdCountEl) createdCountEl.textContent = created.length;
                            if (totalValueEl) totalValueEl.textContent = totalValue.toFixed(2) + ' ETH';

                            // grids
                            const collectedGrid = document.getElementById('collectedGrid');
                            const createdGrid = document.getElementById('createdGrid');

                            renderProfileNftGrid(collectedGrid, collected, 'No collected NFTs yet.');
                            renderProfileNftGrid(createdGrid, created, 'No created NFTs yet.');

                            loadActivityList();
                            loadOffersList();
                            if (typeof loadSentOffersList === 'function') {
                                loadSentOffersList();
                            }

                            const tabsContainer = document.getElementById('profileTabsContainer');
                            if (tabsContainer) tabsContainer.style.display = 'block';
                        }).catch(()=>{});

                        // Deposit / Withdraw logic
                        const depositBtn = document.getElementById('depositBtn');
                        const withdrawBtn = document.getElementById('withdrawBtn');
                        const balanceModal = document.getElementById('balanceModal');
                        const balanceModalTitle = document.getElementById('balanceModalTitle');
                        const balanceAmountInput = document.getElementById('balanceAmountInput');
                        const balanceConfirmBtn = document.getElementById('balanceConfirmBtn');
                        const balanceMaxBtn = document.getElementById('balanceMaxBtn');
                        const balanceModalClose = balanceModal ? balanceModal.querySelector('.balance_modal_close') : null;
                        const walletInput = document.getElementById('walletInput');

                        function showBalanceStatus(msg, ok) {
                            if (!balanceStatus) return;
                            balanceStatus.style.display = 'block';
                            balanceStatus.style.color = ok ? '#10b981' : '#ef4444';
                            balanceStatus.textContent = msg;
                            setTimeout(() => {
                                balanceStatus.style.display = 'none';
                            }, 4000);
                        }

                        function openBalanceModal(action) {
                            if (!balanceModal || !balanceAmountInput || !balanceModalTitle) return;
                            const hasWallet = data.wallet && String(data.wallet).trim().length > 0;
                            const currentWalletVal = walletInput ? walletInput.value.trim() : '';
                            if (!hasWallet && !currentWalletVal) {
                                showBalanceStatus('Please save a wallet address before using balance.', false);
                                if (walletInput) {
                                    walletInput.focus();
                                }
                                return;
                            }
                            balanceModal.setAttribute('data-action', action);
                            balanceModalTitle.textContent = (action === 'withdraw') ? 'Withdraw ETH' : 'Deposit ETH';
                            balanceAmountInput.value = '';
                            if (balanceMaxBtn) {
                                balanceMaxBtn.style.display = (action === 'withdraw') ? 'inline-block' : 'none';
                            }
                            balanceModal.style.display = 'flex';
                        }

                        function closeBalanceModal() {
                            if (!balanceModal) return;
                            balanceModal.style.display = 'none';
                        }

                        if (depositBtn) {
                            depositBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                openBalanceModal('deposit');
                            });
                        }

                        if (withdrawBtn) {
                            withdrawBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                openBalanceModal('withdraw');
                            });
                        }

                        if (balanceModal && balanceModalClose) {
                            balanceModalClose.addEventListener('click', (e) => {
                                e.preventDefault();
                                closeBalanceModal();
                            });
                            balanceModal.addEventListener('click', (e) => {
                                if (e.target === balanceModal) {
                                    closeBalanceModal();
                                }
                            });
                        }

                        if (balanceConfirmBtn && balanceAmountInput && balanceModal) {
                            balanceConfirmBtn.addEventListener('click', async (e) => {
                                e.preventDefault();
                                let rawVal = balanceAmountInput.value.replace(',', '.');
                                let amt = parseFloat(rawVal);
                                if (!amt || amt <= 0) {
                                    showBalanceStatus('Please enter a positive amount.', false);
                                    return;
                                }
                                const action = balanceModal.getAttribute('data-action') || 'deposit';
                                try {
                                    const resp = await fetch('update_balance.php', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ action, amount: amt })
                                    });
                                    const payload = await resp.json();
                                    if (resp.ok && payload && payload.ok) {
                                        currentBalance = typeof payload.balance_eth !== 'undefined'
                                            ? parseFloat(payload.balance_eth)
                                            : currentBalance;
                                        if (isNaN(currentBalance)) currentBalance = 0;
                                        updateBalanceUI();
                                        showBalanceStatus(action === 'withdraw' ? 'Withdraw successful.' : 'Deposit successful.', true);
                                        closeBalanceModal();
                                        // refresh Activity tab live
                                        loadActivityList();
                                    } else {
                                        const code = payload && payload.error ? payload.error : 'unknown_error';
                                        let msg = 'Could not update balance.';
                                        if (code === 'wallet_required') msg = 'Please save a wallet address before using balance.';
                                        if (code === 'insufficient_funds') msg = 'Insufficient funds to withdraw that amount.';
                                        showBalanceStatus(msg, false);
                                    }
                                } catch (err) {
                                    console.error('update_balance error', err);
                                    showBalanceStatus('Network error while updating balance.', false);
                                }
                            });
                        }

                        if (balanceMaxBtn && balanceAmountInput) {
                            balanceMaxBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                balanceAmountInput.value = currentBalance.toFixed(4);
                            });
                        }
                    } else {
                        // Dacă NU e logat, îl trimitem forțat la Login
                        window.location.href = 'login.html';
                    }
                })
                .catch(error => {
                    console.error('Eroare:', error);
                    window.location.href = 'login.html';
                });
            
        });

        // Popup close logic

        // Popup close logic
        document.addEventListener('DOMContentLoaded', () => {
            const popup = document.getElementById('nftPopup');
            if (!popup) return;
            const closeBtn = popup.querySelector('.close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    popup.classList.remove('show');
                });
            }
            window.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.classList.remove('show');
                }
            });
        });
        // Modal logic
        function showVerifyModal(msg) {
            const modal = document.getElementById('verifyModal');
            const msgDiv = document.getElementById('verifyModalMsg');
            const okBtn = document.getElementById('verifyModalOk');
            msgDiv.textContent = msg;
            modal.style.display = 'flex';
            okBtn.onclick = function() {
                modal.style.display = 'none';
                // If rejected, allow new request
                if (msg.includes('rejected')) {
                    const verifyBtn = document.getElementById('getVerifiedBtn');
                    if (verifyBtn) {
                        verifyBtn.textContent = 'Get Verified';
                        verifyBtn.disabled = false;
                        verifyBtn.classList.remove('btn-disabled');
                        verifyBtn.style.opacity = 1;
                        verifyBtn.onclick = function() {
                            window.location.href = 'verify.html';
                        };
                    }
                }
            };
        }

        // Account settings handlers (display name, password, avatar)
        document.addEventListener('DOMContentLoaded', () => {
            const accountModal = document.getElementById('accountModal');
            const accountOpen = document.getElementById('accountSettingsBtn');
            const accountClose = accountModal ? accountModal.querySelector('.account_modal_close') : null;
            const displayNameInput = document.getElementById('displayNameInput');
            const saveDisplayName = document.getElementById('saveDisplayName');
            const currentPassword = document.getElementById('currentPassword');
            const newPassword = document.getElementById('newPassword');
            const confirmPassword = document.getElementById('confirmPassword');
            const savePassword = document.getElementById('savePassword');
            const avatarInput = document.getElementById('avatarInput');
            const saveAvatar = document.getElementById('saveAvatar');
            const accountStatus = document.getElementById('accountStatus');

            function openAccountModal() {
                if (!accountModal) return;
                accountModal.style.display = 'flex';
            }

            function closeAccountModal() {
                if (!accountModal) return;
                accountModal.style.display = 'none';
            }

            if (accountOpen) {
                accountOpen.addEventListener('click', (e) => {
                    e.preventDefault();
                    openAccountModal();
                });
            }

            if (accountClose) {
                accountClose.addEventListener('click', (e) => {
                    e.preventDefault();
                    closeAccountModal();
                });
            }

            if (accountModal) {
                accountModal.addEventListener('click', (e) => {
                    if (e.target === accountModal) {
                        closeAccountModal();
                    }
                });
            }

            function showAccountStatus(msg, ok) {
                if (!accountStatus) return;
                accountStatus.style.display = 'block';
                accountStatus.style.color = ok ? '#10b981' : '#ef4444';
                accountStatus.textContent = msg;
                setTimeout(() => { accountStatus.style.display = 'none'; }, 5000);
            }

            // Pre-populate display name from current username
            fetch('get_profile.php').then(r => r.ok ? r.json() : Promise.reject()).then(d => {
                if (d && d.logged_in && displayNameInput) {
                    displayNameInput.value = d.username || '';
                }
            }).catch(()=>{});

            if (saveDisplayName && displayNameInput) {
                saveDisplayName.addEventListener('click', (e) => {
                    e.preventDefault();
                    const val = displayNameInput.value.trim();
                    if (!val) {
                        showAccountStatus('Display name cannot be empty.', false);
                        return;
                    }
                    const fd = new FormData();
                    fd.append('new_username', val);
                    fetch('update_profile.php', { method:'POST', body: fd, credentials:'include' })
                        .then(r => r.json())
                        .then(resp => {
                            if (resp && resp.ok) {
                                if (resp.username) {
                                    const nameEl = document.getElementById('userName');
                                    if (nameEl) nameEl.childNodes[0].nodeValue = resp.username;
                                }
                                showAccountStatus('Display name updated.', true);
                            } else {
                                showAccountStatus(resp.error || 'Could not update display name.', false);
                            }
                        }).catch(()=>showAccountStatus('Network error updating display name.', false));
                });
            }

            if (savePassword && currentPassword && newPassword && confirmPassword) {
                savePassword.addEventListener('click', (e) => {
                    e.preventDefault();
                    const cur = currentPassword.value;
                    const np = newPassword.value;
                    const cp = confirmPassword.value;
                    if (!cur || !np || !cp) {
                        showAccountStatus('Please fill in all password fields.', false);
                        return;
                    }
                    const fd = new FormData();
                    fd.append('current_password', cur);
                    fd.append('new_password', np);
                    fd.append('confirm_password', cp);
                    fetch('update_profile.php', { method:'POST', body: fd, credentials:'include' })
                        .then(r => r.json())
                        .then(resp => {
                            if (resp && resp.ok && resp.password_changed) {
                                currentPassword.value = '';
                                newPassword.value = '';
                                confirmPassword.value = '';
                                showAccountStatus('Password updated successfully.', true);
                            } else {
                                showAccountStatus(resp.error || 'Could not update password.', false);
                            }
                        }).catch(()=>showAccountStatus('Network error updating password.', false));
                });
            }

            if (saveAvatar && avatarInput) {
                saveAvatar.addEventListener('click', (e) => {
                    e.preventDefault();
                    const file = avatarInput.files[0];
                    if (!file) {
                        // No file chosen yet -> open file picker instead of error
                        avatarInput.click();
                        return;
                    }
                    const fd = new FormData();
                    fd.append('avatar', file);
                    fetch('update_profile.php', { method:'POST', body: fd, credentials:'include' })
                        .then(r => r.json())
                        .then(resp => {
                            if (resp && resp.ok && resp.avatar_url) {
                                const avatarEl2 = document.getElementById('userAvatar');
                                if (avatarEl2) {
                                    avatarEl2.style.backgroundImage = 'url(' + resp.avatar_url + ')';
                                    avatarEl2.style.backgroundSize = 'cover';
                                    avatarEl2.style.backgroundPosition = 'center';
                                    avatarEl2.textContent = '';
                                }
                                showAccountStatus('Profile picture updated.', true);
                            } else {
                                showAccountStatus(resp.error || 'Could not update profile picture.', false);
                            }
                        }).catch(()=>showAccountStatus('Network error updating profile picture.', false));
                });
            }
        });
    </script>

    <footer class="footer">

        <div class="footer1">

            <div class = "footer11">
            <span class="nexus_logo">N</span>
            <span class="footer_text_big">Nexus</span>
            </div>

            <div class="footer12">
                <span class="footer_text">The future of digital art collecting. Discover, collect, and trade unique NFTs.</span>
            
            </div>

        </div>

        <div class="footer2">
        
            <span class="footer_text_big">Marketplace</span>
            <a href="explore.html" class="small_button_footer">Explore</a>
            <a href="create.html" class="small_button_footer">Mint</a>
            <a href="collections.html" class="small_button_footer">Collections</a>

        </div>

        <div class="footer3">

            <span class="footer_text_big">Resources</span>
            <a href="helpcenter.html" class="small_button_footer">Help Center</a>
            <a href="contact.html" class="small_button_footer">Contact</a>
            <a href="newsletter.html" class="small_button_footer">Newsletter</a>

        </div>

        <div class="footer4">
            <span class="footer_text_big">Community</span>
            <div class="footer41">
            <a href="https://www.twitter.com" class="twitter">
                <svg class="icon-twitter" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none">
                    <path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z">
                    </path>
                 </svg>  
            </a>

            <a href="https://www.twitter.com" class="message">
                <svg class="icon-message" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none">
                    <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z">
                    </path>
                 </svg>  
            </a>

            <a href="https://github.com/AKVlad04/SavuVladutGeorge" class="github">
                <svg class="icon-github" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none">
                    <path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path>
                    <path d="M9 18c-4.51 2-5-2-7-2"></path>
                </svg>  
            </a>
        </div>
        </div>
    </footer>

</body>
</html>