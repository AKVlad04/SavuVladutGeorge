<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="profile.css">
    <title>My Profile - Nexus</title>
    <script src="script.js" defer></script>
    <script src="owner.js" defer></script>
</head>
<body>

    <header class="top_bar">
        <a href="index.html" class="logo">
            <span class="nexus_logo">N</span>
            <span class="nexus">Nexus</span>
        </a>   
        <div class="buttons_footer">
            <a href="index.html" class="home_button">Home</a>
            <a href="explore.html" class="explore_button">Explore</a>
               <a href="wishlist.html" class="wishlist_button">Wishlist</a>
            <a href="create.html" class="create_button">Mint</a>
            <a href="profile.html" class="profile_button">Profile</a>
            <a href="dashboard.html" id="ownerDashboardLink" class="profile_button" style="visibility:hidden">Dashboard</a>
        </div>
        <a href="logout.php" class="connect_wallet" style="border-color: #ef4444;">
            <span class="connect_wallet_text" style="color: #ef4444;">Logout</span>
        </a>
    </header>

    <div class="profile_page">
        <div class="profile_card" id="profileCard" style="opacity: 0; transition: opacity 0.5s;">
            
            <div class="profile_avatar" id="userAvatar">?</div>
            
            <h1 class="profile_name" id="userName">Loading...</h1>
            <span class="profile_email" id="userEmail">...</span>

            <div class="profile_stats">
                <div class="stat_box">
                    <span class="stat_value" id="userRole">...</span>
                    <span class="stat_label">Role</span>
                </div>
                <div class="stat_box">
                    <span class="stat_value" id="userStatus" style="color: #10b981;">...</span>
                    <span class="stat_label">Status</span>
                </div>
                <div class="stat_box">
                    <span class="stat_value" id="userId">#0</span>
                    <span class="stat_label">ID</span>
                </div>
            </div>

            <div class="profile_actions">
                <button id="accountSettingsBtn" class="account_btn">Account settings</button>
                <a href="logout.php" class="logout_btn">Sign Out</a>
            </div>

            <button id="getVerifiedBtn" class="verify_btn" style="margin-top:18px;">Get Verified</button>

            <div class="wallet_row">
                <label for="walletInput">Wallet address</label>
                <div class="wallet_controls">
                    <input type="text" id="walletInput" placeholder="0x..." />
                    <button id="saveWallet">Save</button>
                </div>
                <p id="saveStatus" style="display:none"></p>
            </div>
        </div>
            <div class="owned_section" id="ownedSection" style="width:100%; max-width:1100px; margin-top:30px; display:none">
                <h2 style="color:#fff; margin-bottom:12px">Your NFTs</h2>
                <div id="ownedNfts" class="owned_grid"></div>
            </div>
    </div>

    <!-- NFT Details Popup (reuse global style) -->
    <div id="nftPopup" class="popup">
      <div class="popup-content">
        <span class="close">&times;</span>

        <div class="popup_nftdetails">
            <span class="popup_nfttext">NFT Details</span>
        </div>

        <div class="pop_mare">
            <div class="popup_image_wrapper">
                <img id="popupImage" src="" alt="NFT preview">
            </div>
            <div class="pop_detalii">
                <p id="popupCategory"></p>
                <h2 id="popupTitle"></h2>

                <p id="popupDescription"></p>

                <div class="currentPrice">
                    <span id="current_price">Current Price</span>
                    <p id="popupPrice"></p>
                    <span id="aprox">≈ $0.00 USD</span>
                </div>

                <div class="owner_creator_boxes">
                    <div class="owner_box">
                        <span class="label">Owner</span>
                        <span id="popupOwner" class="value">-</span>
                    </div>
                    <div class="creator_box">
                        <span class="label">Creator</span>
                        <span id="popupCreator" class="value">-</span>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>

    <div id="verifyModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:9999;align-items:center;justify-content:center;">
        <div style="background:#23272f;padding:32px 28px;border-radius:16px;max-width:350px;width:90vw;color:#fff;box-shadow:0 4px 24px #000a;display:flex;flex-direction:column;align-items:center;">
            <div id="verifyModalMsg" style="margin-bottom:18px;font-size:1.1em;text-align:center;"></div>
            <button id="verifyModalOk" class="verify_btn" style="margin-top:8px;">OK</button>
        </div>
    </div>

    <div id="accountModal" class="account_modal_overlay">
        <div class="account_modal">
            <button type="button" class="account_modal_close">&times;</button>
            <h3 class="account_modal_title">Account settings</h3>

            <div class="account_row">
                <div class="account_field">
                    <label for="displayNameInput">Display name</label>
                    <div class="wallet_controls">
                        <input type="text" id="displayNameInput" placeholder="Your username" />
                        <button id="saveDisplayName">Save</button>
                    </div>
                </div>

                <div class="account_field">
                    <label>Change password</label>
                    <div class="password_grid">
                        <input type="password" id="currentPassword" placeholder="Current password" />
                        <input type="password" id="newPassword" placeholder="New password" />
                        <input type="password" id="confirmPassword" placeholder="Confirm new password" />
                        <button id="savePassword">Update password</button>
                    </div>
                </div>

                <div class="account_field">
                    <label for="avatarInput">Profile picture</label>
                    <div class="avatar_controls">
                        <input type="file" id="avatarInput" accept="image/png,image/jpeg,image/gif,image/webp" />
                        <button id="saveAvatar">Upload</button>
                    </div>
                    <p id="accountStatus" style="display:none"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            fetch('get_profile.php')
                .then(response => response.json())
                .then(data => {
                    if (data.logged_in) {
                        document.getElementById('userName').textContent = data.username;
                        // Show checkmark if verified
                        if (data.is_verified && Number(data.is_verified) === 1) {
                            const check = document.createElement('span');
                            check.innerHTML = ' <svg style="vertical-align:middle;margin-left:4px;" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="10" fill="#10b981"/><path d="M6 10.5L9 13.5L14 8.5" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                            document.getElementById('userName').appendChild(check);
                            // Hide verify button if present
                            const verifyBtn = document.getElementById('getVerifiedBtn');
                            if (verifyBtn) verifyBtn.style.display = 'none';
                        } else {
                            // Check for pending/rejected verification request
                            fetch('get_verification_status.php')
                                .then(r => r.json())
                                .then(vs => {
                                    const verifyBtn = document.getElementById('getVerifiedBtn');
                                    if (!verifyBtn) return;
                                    if (vs.status === 'pending') {
                                        verifyBtn.textContent = 'Verification Pending';
                                        verifyBtn.disabled = false;
                                        verifyBtn.classList.add('btn-disabled');
                                        verifyBtn.style.opacity = 0.8;
                                        verifyBtn.onclick = function() {
                                            showVerifyModal('Your verification request is pending review. Please wait for an admin to approve or reject your request.');
                                        };
                                    } else if (vs.status === 'approved') {
                                        verifyBtn.style.display = 'none';
                                        // Optionally, show checkmark (already handled above)
                                    } else if (vs.status === 'rejected') {
                                        verifyBtn.textContent = 'Verification Rejected';
                                        verifyBtn.disabled = false;
                                        verifyBtn.classList.add('btn-disabled');
                                        verifyBtn.style.opacity = 0.8;
                                        verifyBtn.onclick = function() {
                                            showVerifyModal('Your verification request was rejected. You can submit a new request.');
                                        };
                                    } else {
                                        verifyBtn.textContent = 'Get Verified';
                                        verifyBtn.disabled = false;
                                        verifyBtn.classList.remove('btn-disabled');
                                        verifyBtn.style.opacity = 1;
                                        verifyBtn.onclick = function() {
                                            window.location.href = 'verify.html';
                                        };
                                    }
                                });
                        }
                        document.getElementById('userEmail').textContent = data.email;
                        document.getElementById('userStatus').textContent = data.status;
                        document.getElementById('userRole').textContent = data.role || 'User';
                        document.getElementById('userId').textContent = "#" + data.id;
                        const avatarEl = document.getElementById('userAvatar');
                        if (data.avatar_url) {
                            avatarEl.style.backgroundImage = 'url(' + data.avatar_url + ')';
                            avatarEl.style.backgroundSize = 'cover';
                            avatarEl.style.backgroundPosition = 'center';
                            avatarEl.textContent = '';
                        } else {
                            avatarEl.textContent = data.initial;
                        }
                        
                        // Facem cardul vizibil
                        document.getElementById('profileCard').style.opacity = '1';

                        // helper to open NFT popup from owned list
                        function openOwnedNftPopup(nft, username) {
                            const popup = document.getElementById('nftPopup');
                            if (!popup) return;
                            const popupTitle = document.getElementById('popupTitle');
                            const popupCategory = document.getElementById('popupCategory');
                            const popupDescription = document.getElementById('popupDescription');
                            const popupPrice = document.getElementById('popupPrice');
                            const popupImg = document.getElementById('popupImage');
                            const popupOwner = document.getElementById('popupOwner');
                            const popupCreator = document.getElementById('popupCreator');
                            const aproxEl = document.getElementById('aprox');

                            popupTitle.textContent = nft.name || '';
                            popupCategory.textContent = nft.category || '';
                            popupDescription.textContent = nft.description || '';
                            popupPrice.textContent = (nft.price || 0) + ' ETH';
                            popupImg.src = nft.image_url || 'img/placeholder.jpg';

                            const ownerNameRaw = nft.owner_name || username || '';
                            const creatorNameRaw = nft.creator_name || ownerNameRaw || '';

                            if (popupOwner) {
                                popupOwner.textContent = ownerNameRaw || '—';
                                popupOwner.style.cursor = ownerNameRaw ? 'pointer' : 'default';
                                popupOwner.onclick = null;
                                if (ownerNameRaw) {
                                    popupOwner.onclick = () => {
                                        window.location.href = 'profile.html';
                                    };
                                }
                            }

                            if (popupCreator) {
                                popupCreator.textContent = creatorNameRaw || '—';
                                popupCreator.style.cursor = creatorNameRaw ? 'default' : 'default';
                                popupCreator.onclick = null;
                            }

                            // simple approximate USD value using static rate
                            const ethVal = parseFloat(nft.price) || 0;
                            const rate = 1900; // fallback USD per ETH
                            if (aproxEl) {
                                aproxEl.textContent = '≈ $' + (ethVal * rate).toFixed(2) + ' USD';
                            }

                            popup.classList.add('show');
                        }

                        // Load user's owned NFTs and render
                        fetch('nfts.php').then(r=>r.json()).then(nfts=>{
                            if (!Array.isArray(nfts)) return;
                            const owned = nfts.filter(n => n.owner_id && Number(n.owner_id) === Number(data.id));
                            const ownedSection = document.getElementById('ownedSection');
                            const ownedGrid = document.getElementById('ownedNfts');
                            if (owned.length === 0) {
                                ownedSection.style.display = 'none';
                                return;
                            }
                            ownedSection.style.display = 'block';
                            ownedGrid.innerHTML = '';
                            owned.forEach(n => {
                                const d = document.createElement('div');
                                d.className = 'owned_item';
                                d.innerHTML = `<div class="owned_img"><img src="${n.image_url||'img/placeholder.jpg'}" alt="${n.name}"></div><div class="owned_meta"><div class="owned_name">${n.name}</div><div class="owned_price">${n.price} ETH</div></div>`;
                                d.addEventListener('click', () => openOwnedNftPopup(n, data.username));
                                ownedGrid.appendChild(d);
                            });
                        }).catch(()=>{});
                    } else {
                        // Dacă NU e logat, îl trimitem forțat la Login
                        window.location.href = 'login.html';
                    }
                })
                .catch(error => {
                    console.error('Eroare:', error);
                    window.location.href = 'login.html';
                });
            
        });

        // Popup close logic

        // Popup close logic
        document.addEventListener('DOMContentLoaded', () => {
            const popup = document.getElementById('nftPopup');
            if (!popup) return;
            const closeBtn = popup.querySelector('.close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    popup.classList.remove('show');
                });
            }
            window.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.classList.remove('show');
                }
            });
        });
        // Modal logic
        function showVerifyModal(msg) {
            const modal = document.getElementById('verifyModal');
            const msgDiv = document.getElementById('verifyModalMsg');
            const okBtn = document.getElementById('verifyModalOk');
            msgDiv.textContent = msg;
            modal.style.display = 'flex';
            okBtn.onclick = function() {
                modal.style.display = 'none';
                // If rejected, allow new request
                if (msg.includes('rejected')) {
                    const verifyBtn = document.getElementById('getVerifiedBtn');
                    if (verifyBtn) {
                        verifyBtn.textContent = 'Get Verified';
                        verifyBtn.disabled = false;
                        verifyBtn.classList.remove('btn-disabled');
                        verifyBtn.style.opacity = 1;
                        verifyBtn.onclick = function() {
                            window.location.href = 'verify.html';
                        };
                    }
                }
            };
        }

        // Account settings handlers (display name, password, avatar)
        document.addEventListener('DOMContentLoaded', () => {
            const accountModal = document.getElementById('accountModal');
            const accountOpen = document.getElementById('accountSettingsBtn');
            const accountClose = accountModal ? accountModal.querySelector('.account_modal_close') : null;
            const displayNameInput = document.getElementById('displayNameInput');
            const saveDisplayName = document.getElementById('saveDisplayName');
            const currentPassword = document.getElementById('currentPassword');
            const newPassword = document.getElementById('newPassword');
            const confirmPassword = document.getElementById('confirmPassword');
            const savePassword = document.getElementById('savePassword');
            const avatarInput = document.getElementById('avatarInput');
            const saveAvatar = document.getElementById('saveAvatar');
            const accountStatus = document.getElementById('accountStatus');

            function openAccountModal() {
                if (!accountModal) return;
                accountModal.style.display = 'flex';
            }

            function closeAccountModal() {
                if (!accountModal) return;
                accountModal.style.display = 'none';
            }

            if (accountOpen) {
                accountOpen.addEventListener('click', (e) => {
                    e.preventDefault();
                    openAccountModal();
                });
            }

            if (accountClose) {
                accountClose.addEventListener('click', (e) => {
                    e.preventDefault();
                    closeAccountModal();
                });
            }

            if (accountModal) {
                accountModal.addEventListener('click', (e) => {
                    if (e.target === accountModal) {
                        closeAccountModal();
                    }
                });
            }

            function showAccountStatus(msg, ok) {
                if (!accountStatus) return;
                accountStatus.style.display = 'block';
                accountStatus.style.color = ok ? '#10b981' : '#ef4444';
                accountStatus.textContent = msg;
                setTimeout(() => { accountStatus.style.display = 'none'; }, 5000);
            }

            // Pre-populate display name from current username
            fetch('get_profile.php').then(r => r.ok ? r.json() : Promise.reject()).then(d => {
                if (d && d.logged_in && displayNameInput) {
                    displayNameInput.value = d.username || '';
                }
            }).catch(()=>{});

            if (saveDisplayName && displayNameInput) {
                saveDisplayName.addEventListener('click', (e) => {
                    e.preventDefault();
                    const val = displayNameInput.value.trim();
                    if (!val) {
                        showAccountStatus('Display name cannot be empty.', false);
                        return;
                    }
                    const fd = new FormData();
                    fd.append('new_username', val);
                    fetch('update_profile.php', { method:'POST', body: fd, credentials:'include' })
                        .then(r => r.json())
                        .then(resp => {
                            if (resp && resp.ok) {
                                if (resp.username) {
                                    const nameEl = document.getElementById('userName');
                                    if (nameEl) nameEl.childNodes[0].nodeValue = resp.username;
                                }
                                showAccountStatus('Display name updated.', true);
                            } else {
                                showAccountStatus(resp.error || 'Could not update display name.', false);
                            }
                        }).catch(()=>showAccountStatus('Network error updating display name.', false));
                });
            }

            if (savePassword && currentPassword && newPassword && confirmPassword) {
                savePassword.addEventListener('click', (e) => {
                    e.preventDefault();
                    const cur = currentPassword.value;
                    const np = newPassword.value;
                    const cp = confirmPassword.value;
                    if (!cur || !np || !cp) {
                        showAccountStatus('Please fill in all password fields.', false);
                        return;
                    }
                    const fd = new FormData();
                    fd.append('current_password', cur);
                    fd.append('new_password', np);
                    fd.append('confirm_password', cp);
                    fetch('update_profile.php', { method:'POST', body: fd, credentials:'include' })
                        .then(r => r.json())
                        .then(resp => {
                            if (resp && resp.ok && resp.password_changed) {
                                currentPassword.value = '';
                                newPassword.value = '';
                                confirmPassword.value = '';
                                showAccountStatus('Password updated successfully.', true);
                            } else {
                                showAccountStatus(resp.error || 'Could not update password.', false);
                            }
                        }).catch(()=>showAccountStatus('Network error updating password.', false));
                });
            }

            if (saveAvatar && avatarInput) {
                saveAvatar.addEventListener('click', (e) => {
                    e.preventDefault();
                    const file = avatarInput.files[0];
                    if (!file) {
                        // No file chosen yet -> open file picker instead of error
                        avatarInput.click();
                        return;
                    }
                    const fd = new FormData();
                    fd.append('avatar', file);
                    fetch('update_profile.php', { method:'POST', body: fd, credentials:'include' })
                        .then(r => r.json())
                        .then(resp => {
                            if (resp && resp.ok && resp.avatar_url) {
                                const avatarEl2 = document.getElementById('userAvatar');
                                if (avatarEl2) {
                                    avatarEl2.style.backgroundImage = 'url(' + resp.avatar_url + ')';
                                    avatarEl2.style.backgroundSize = 'cover';
                                    avatarEl2.style.backgroundPosition = 'center';
                                    avatarEl2.textContent = '';
                                }
                                showAccountStatus('Profile picture updated.', true);
                            } else {
                                showAccountStatus(resp.error || 'Could not update profile picture.', false);
                            }
                        }).catch(()=>showAccountStatus('Network error updating profile picture.', false));
                });
            }
        });
    </script>
    

</body>
</html>